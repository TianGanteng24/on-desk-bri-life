<%- include('../layout/header', { user }) %>

<div class="max-w-7xl mx-auto px-6 py-8">

<div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden">
  <div class="px-6 py-4 border-b dark:border-slate-700 flex justify-between items-center">
    <div>
      <h2 class="text-2xl font-bold">ğŸ“‹ Data Laporan Investigasi</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Total: <span id="totalData"><%= data.length %></span> laporan</p>
    </div>

    <div class="flex gap-2 items-center">
      <!-- Search Bar -->
      <div class="relative">
        <input type="text" id="searchInput" placeholder="Cari data..." 
          class="pl-8 pr-4 py-2 border rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none w-64 transition">
        <span class="absolute left-2.5 top-2.5 text-gray-400">ğŸ”</span>
      </div>

  <% if (user.role === 'admin') { %>
    <a href="/users"
      class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
      ğŸ‘¥ Kelola User
    </a>
  <% } %>
  
  <a href="/laporan/create"
    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
    â• Tambah Laporan
  </a>
</div>
  </div>

  <div class="overflow-x-auto">
  <table class="w-full">
    <thead class="bg-gray-100 dark:bg-slate-700 border-b dark:border-slate-600">
      <tr>
        <th class="px-6 py-4 text-left font-semibold">No</th>
        <th class="px-6 py-4 text-left font-semibold">Pemegang Polis</th>
        <th class="px-6 py-4 text-left font-semibold">No Peserta</th>
        <th class="px-6 py-4 text-left font-semibold">Nama Tertanggung</th>
        <th class="px-6 py-4 text-left font-semibold">Status</th>
        <th class="px-6 py-4 text-center font-semibold">Aksi</th>
      </tr>
    </thead>

    <tbody>
    <% if (data.length === 0) { %>
      <tr>
        <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
          Belum ada data laporan. <a href="/laporan/create" class="text-emerald-600 hover:underline">Buat laporan baru</a>
        </td>
      </tr>
    <% } else { %>
      <% data.forEach((r, i) => { %>
      <tr class="border-t dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700 transition">
        <td class="px-6 py-4 font-medium text-gray-600 dark:text-gray-300"><%= i + 1 %></td>
        <td class="px-6 py-4 font-medium"><%= r.nama_pemegang_polis || '-' %></td>
        <td class="px-6 py-4"><%= r.no_peserta || '-' %></td>
        <td class="px-6 py-4"><%= r.nama_tertanggung || '-' %></td>
        <td class="px-6 py-4">
          <% if (r.status_asuransi === 'done') { %>
            <span class="px-3 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100 rounded-full text-xs font-medium">âœ“ Done</span>
          <% } else if (r.status_asuransi === 'ongoing') { %>
            <span class="px-3 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-100 rounded-full text-xs font-medium">âŠ On Going</span>
          <% } else if (r.status_asuransi === 'case-close') { %>
            <span class="px-3 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-100 rounded-full text-xs font-medium">âœ• Case Close    </span>
          <% } else { %>
            <span class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full text-xs font-medium">â€”</span>
          <% } %>
        </td>   
        <td class="px-6 py-4">
          <div class="flex justify-center gap-2 flex-wrap">
            <a href="/laporan/<%= r.id %>" 
               title="Lihat detail"
               class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition font-medium">
              ğŸ‘ï¸
            </a>
            <a href="/laporan/pdf/<%= r.id %>" target="_blank"
               title="Lihat PDF"
               class="px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white text-xs rounded transition font-medium">
              ğŸ“„
            </a>

            <% if (user.role === 'admin') { %>
            <a href="/laporan/edit/<%= r.id %>"
               title="Edit laporan"
               class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-xs rounded transition font-medium">
              âœï¸
            </a>
            <button onclick="deleteLaporan('<%= r.id %>')"
               title="Hapus laporan"
               class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded transition font-medium">
              ğŸ—‘ï¸
            </button>
            <% } %>
          </div>
        </td>
      </tr>
      <% }) %>
    <% } %>
    </tbody>
  </table>
  </div>

  <!-- Pagination Controls -->
  <div class="px-6 py-4 border-t dark:border-slate-700 flex justify-between items-center bg-gray-50 dark:bg-slate-800/50">
    <div class="text-sm text-gray-500">
      Menampilkan <span id="startRange">0</span> - <span id="endRange">0</span> dari <span id="filteredTotal">0</span> data
    </div>
    <div class="flex gap-2" id="paginationButtons">
      <!-- Buttons will be generated here -->
    </div>
  </div>
</div>

<script>
let allData = [];
const itemsPerPage = 10;
let currentPage = 1;
let filteredData = [];

// Initialize data from EJS
document.addEventListener('DOMContentLoaded', () => {
  const tableRows = document.querySelectorAll('tbody tr:not(:first-child)'); // Skip "no data" row if exists
  // If there's only one row and it's the "no data" row, handle it
  const noDataRow = document.querySelector('tbody tr td[colspan="6"]');
  
  if (noDataRow) {
    allData = [];
  } else {
    document.querySelectorAll('tbody tr').forEach(row => {
      allData.push({
        element: row,
        text: row.innerText.toLowerCase()
      });
    });
  }

  filteredData = [...allData];
  renderTable();

  // Search event
  document.getElementById('searchInput').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    filteredData = allData.filter(item => item.text.includes(term));
    currentPage = 1;
    renderTable();
  });
});

function renderTable() {
  const tbody = document.querySelector('tbody');
  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const pageItems = filteredData.slice(start, end);

  // Clear table but keep "no data" structure if empty
  tbody.innerHTML = '';

  if (filteredData.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
          Data tidak ditemukan.
        </td>
      </tr>
    `;
    updatePagination(0);
  } else {
    pageItems.forEach((item, index) => {
      // Update row number (No)
      const noCell = item.element.querySelector('td:first-child');
      if (noCell) noCell.innerText = start + index + 1;
      tbody.appendChild(item.element);
    });
    updatePagination(filteredData.length);
  }

  // Update stats
  document.getElementById('filteredTotal').innerText = filteredData.length;
  document.getElementById('startRange').innerText = filteredData.length > 0 ? start + 1 : 0;
  document.getElementById('endRange').innerText = Math.min(end, filteredData.length);
  document.getElementById('totalData').innerText = allData.length;
}

function updatePagination(totalItems) {
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const container = document.getElementById('paginationButtons');
  container.innerHTML = '';

  if (totalPages <= 1) return;

  // Previous Button
  const prevBtn = createPageButton('Sebelumnya', currentPage > 1, () => {
    currentPage--;
    renderTable();
  });
  container.appendChild(prevBtn);

  // Page Numbers
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
      const btn = createPageButton(i, true, () => {
        currentPage = i;
        renderTable();
      }, i === currentPage);
      container.appendChild(btn);
    } else if (i === currentPage - 2 || i === currentPage + 2) {
      const dots = document.createElement('span');
      dots.innerText = '...';
      dots.className = 'px-2 py-1 text-gray-400';
      container.appendChild(dots);
    }
  }

  // Next Button
  const nextBtn = createPageButton('Selanjutnya', currentPage < totalPages, () => {
    currentPage++;
    renderTable();
  });
  container.appendChild(nextBtn);
}

function createPageButton(text, enabled, onClick, active = false) {
  const btn = document.createElement('button');
  btn.innerText = text;
  btn.disabled = !enabled;
  btn.className = `px-3 py-1 rounded-lg text-sm transition ${
    active 
      ? 'bg-indigo-600 text-white' 
      : enabled 
        ? 'bg-white dark:bg-slate-700 border dark:border-slate-600 hover:bg-gray-100 dark:hover:bg-slate-600' 
        : 'bg-gray-100 text-gray-400 cursor-not-allowed'
  }`;
  if (enabled) btn.onclick = onClick;
  return btn;
}

function deleteLaporan(id) {
  Swal.fire({
    title: 'Apakah Anda yakin?',
    text: "Laporan yang dihapus tidak dapat dikembalikan!",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Ya, hapus!',
    cancelButtonText: 'Batal'
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = '/laporan/delete/' + id;
    }
  })
}
</script>

<%- include('../layout/footer') %>
