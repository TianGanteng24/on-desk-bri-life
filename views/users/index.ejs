<%- include('../layout/header', { user }) %>

<div class="max-w-7xl mx-auto px-6 py-8">
  <div
    class="bg-[#1e293b] rounded-2xl shadow-xl overflow-hidden border border-slate-700"
  >
    <div
      class="px-6 py-6 border-b border-slate-700 flex justify-between items-center bg-[#1e293b]"
    >
      <div>
        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
          <span class="text-indigo-400">üë•</span> Manajemen Pengguna
        </h2>
        <p class="text-sm text-slate-400 mt-1">
          Total: <%= users.length %> pengguna terdaftar
        </p>
      </div>

      <button
        type="button"
        onclick="openModal()"
        class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl text-sm font-semibold transition-all shadow-lg flex items-center gap-2"
      >
        <span class="text-lg">+</span> Tambah User Baru
      </button>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr
            class="bg-slate-800/50 text-slate-300 uppercase text-xs tracking-wider"
          >
            <th class="px-6 py-4 font-bold">No</th>
            <th class="px-6 py-4 font-bold">Username / Email</th>
            <th class="px-6 py-4 font-bold">Role</th>
            <th class="px-6 py-4 text-center font-bold">Aksi</th>
          </tr>
        </thead>
        <tbody class="text-slate-300 divide-y divide-slate-700">
          <% users.forEach((u, i) => { %>
          <tr class="hover:bg-slate-700/30 transition-colors">
            <td class="px-6 py-4 text-sm text-slate-500"><%= i + 1 %></td>
            <td class="px-6 py-4 text-sm text-slate-400">
              <%= u.username || u.email %>
            </td>
            <td class="px-6 py-4">
              <span
                class="px-3 py-1 <%= u.role === 'admin' ? 'bg-purple-500/10 text-purple-400 border-purple-500/20' : 'bg-blue-500/10 text-blue-400 border-blue-500/20' %> border rounded-full text-[10px] font-bold uppercase tracking-tighter"
              >
                <%= u.role === 'admin' ? 'üõ°Ô∏è Admin' : 'üë§ ' + u.role %>
              </span>
            </td>
            <td class="px-6 py-4 text-center">
              <div class="flex justify-center gap-3">
                <% if (u.role !== 'admin') { %>
                <button
                  type="button"
                  onclick="openEditModal('<%= u.id %>', '<%= u.username %>', '<%= u.role %>', '<%= u.nama_lengkap %>')"
                  class="hidden p-2 bg-amber-500/10 text-amber-500 hover:bg-amber-500 hover:text-white rounded-lg transition-all"
                >
                  ‚úèÔ∏è
                </button>
                <% } %>
              

                <% if (u.id !== user.id) { %>
                <a
                  href="/users/delete/<%= u.id %>"
                  onclick="return confirm('Apakah Anda yakin ingin menghapus user ini?')"
                  class="p-2 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white rounded-lg transition-all"
                >
                  üóëÔ∏è
                </a>
                <% } %>
              </div>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div
  id="createUserModal"
  class="fixed inset-0 z-[60] hidden items-center justify-center p-4"
>
  <div
    class="fixed inset-0 bg-black/70 backdrop-blur-sm"
    onclick="closeModal()"
  ></div>

  <div
    class="relative bg-slate-900 w-full max-w-md rounded-2xl shadow-2xl border border-slate-700 transform transition-all overflow-hidden"
  >
    <div
      class="px-6 py-4 border-b border-slate-800 flex justify-between items-center"
    >
      <h3 class="text-xl font-bold text-white">Tambah User Baru</h3>
      <button onclick="closeModal()" class="text-slate-400 hover:text-white">
        <svg
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <form action="/users/create" method="POST">
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-400 mb-1"
            >Username / Email</label
          >
          <input
            type="text"
            name="username"
            class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
            required
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-400 mb-1"
            >Password</label
          >
          <input
            type="password"
            name="password"
            class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
            required
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-400 mb-1"
            >Role Akses</label
          >
          <select
            name="role"
            class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
            required
          >
            <option value="">-- Pilih Role --</option>
            <option value="admin">Admin</option>
            <option value="bri">BRI</option>
            <option value="deswa">Deswa</option>
          </select>
        </div>
      </div>
      <div
        class="px-6 py-4 bg-slate-800/50 border-t border-slate-800 flex justify-end gap-3"
      >
        <button
          type="button"
          onclick="closeModal()"
          class="text-slate-400 hover:text-white text-sm font-semibold px-4"
        >
          Batal
        </button>
        <button
          type="submit"
          class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg"
        >
          Simpan User
        </button>
      </div>
    </form>
  </div>
</div>

<div id="editUserModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4">
  <div class="fixed inset-0 bg-black/70 backdrop-blur-sm" onclick="closeEditModal()"></div>
  <div class="relative bg-slate-900 w-full max-w-md rounded-2xl shadow-2xl border border-slate-700 overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-800 flex justify-between items-center">
      <h3 class="text-xl font-bold text-white">Edit User</h3>
      <button onclick="closeEditModal()" class="text-slate-400 hover:text-white">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>

    <form id="editForm" action="/users/update" method="POST">
      <input type="hidden" name="id" id="edit_id">
      
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-400 mb-1">Username / Email</label>
          <input type="text" name="username" id="edit_username" class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-xl outline-none focus:ring-2 focus:ring-amber-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-400 mb-1 text-xs">Password (Kosongkan jika tidak diganti)</label>
          <input type="password" name="password" class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-xl outline-none focus:ring-2 focus:ring-amber-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-400 mb-1">Role Akses</label>
          <select name="role" id="edit_role" class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-xl outline-none focus:ring-2 focus:ring-amber-500" required>
            <option value="admin">Admin</option>
            <option value="bri">BRI</option>
            <option value="deswa">Deswa</option>
          </select>
        </div>
      </div>
      <div class="px-6 py-4 bg-slate-800/50 border-t border-slate-800 flex justify-end gap-3">
        <button type="button" onclick="closeEditModal()" class="text-slate-400 hover:text-white text-sm font-semibold px-4">Batal</button>
        <button type="submit" class="bg-amber-500 hover:bg-amber-600 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg">Update User</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Fungsi Modal Tambah (Sudah ada sebelumnya)
  function openModal() {
    document.getElementById('createUserModal').classList.remove('hidden');
    document.getElementById('createUserModal').classList.add('flex');
    document.body.style.overflow = 'hidden';
  }
  function closeModal() {
    document.getElementById('createUserModal').classList.add('hidden');
    document.getElementById('createUserModal').classList.remove('flex');
    document.body.style.overflow = 'auto';
  }

  // FUNGSI MODAL EDIT (BARU)
  function openEditModal(id, username, role, nama) {
    // Isi data ke dalam input modal edit
    document.getElementById('edit_id').value = id;
    document.getElementById('edit_username').value = username;
    document.getElementById('edit_role').value = role;

    // Tampilkan modal
    const modal = document.getElementById('editUserModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }

  function closeEditModal() {
    const modal = document.getElementById('editUserModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.body.style.overflow = 'auto';
  }

  // Global ESC key listener
  document.addEventListener('keydown', (e) => {
    if (e.key === "Escape") {
      closeModal();
      closeEditModal();
    }
  });
</script>
<%- include('../layout/footer') %>
